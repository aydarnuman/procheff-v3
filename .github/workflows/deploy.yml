name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Manual trigger option

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. Test Build (ensure everything compiles)
      - name: Install dependencies and build
        run: |
          npm ci --ignore-scripts
          npm run build
        env:
          NEXT_PUBLIC_ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}

      # 4. Setup SSH connection
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      # 5. Deploy to server
      - name: Deploy to DigitalOcean
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'ENDSSH'
            set -e
            
            # Navigate to project directory
            cd /root/procheff-v3
            
            # Pull latest changes
            git pull origin main
            
            # Install dependencies
            npm ci --production
            
            # Build the application
            npm run build
            
            # Copy environment variables
            cat > .env.local << EOF
            NEXT_PUBLIC_ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            SMTP_HOST=${{ secrets.SMTP_HOST }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            SMTP_USER=${{ secrets.SMTP_USER }}
            SMTP_PASS=${{ secrets.SMTP_PASS }}
            SMTP_FROM=${{ secrets.SMTP_FROM }}
            SMTP_TEST_MODE=false
            EOF
            
            # Restart application
            pm2 restart procheff-v3 || pm2 start npm --name "procheff-v3" -- start
            
            # Save PM2 configuration
            pm2 save
            
            echo "Deployment completed successfully!"
          ENDSSH

      # 6. Health check
      - name: Health Check
        run: |
          sleep 30
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.DEPLOY_HOST }}:3000/api/health || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Application is healthy!"
          else
            echo "âŒ Health check failed with status: $response"
            exit 1
          fi

      # 7. Notify success (optional)
      - name: Deployment Success
        if: success()
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ Application URL: http://${{ secrets.DEPLOY_HOST }}:3000"

      # 8. Cleanup on failure
      - name: Cleanup on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed. Please check the logs."