name: Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
      - run: |
          ssh -o StrictHostKeyChecking=no root@104.248.254.171 "
            cd /var/www/procheff &&
            git pull &&
            npm install --omit=dev --ignore-scripts &&
            cat > tsconfig.json << 'TSCONFIG'
            {
              \"compilerOptions\": {
                \"target\": \"ES2017\",
                \"lib\": [\"dom\", \"dom.iterable\", \"esnext\"],
                \"allowJs\": true,
                \"skipLibCheck\": true,
                \"strict\": true,
                \"noEmit\": true,
                \"esModuleInterop\": true,
                \"module\": \"esnext\",
                \"moduleResolution\": \"bundler\",
                \"resolveJsonModule\": true,
                \"isolatedModules\": true,
                \"jsx\": \"react-jsx\",
                \"incremental\": true,
                \"plugins\": [{\"name\": \"next\"}],
                \"paths\": {\"@/*\": [\"./src/*\"]}
              },
              \"include\": [\"next-env.d.ts\", \"**/*.ts\", \"**/*.tsx\", \".next/types/**/*.ts\"],
              \"exclude\": [\"node_modules\", \"ihale-worker\", \"scripts\"]
            }
            TSCONFIG
            npm run build &&
            pm2 restart procheff || pm2 start npm --name procheff -- start
          "

